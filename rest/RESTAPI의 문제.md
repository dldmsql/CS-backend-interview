# Restful API 서버를 위협하는 한 글자, 슬래시

> 아래에서 정리하는 내용은 넷마블 보안팀의 인터뷰에서 발췌한 내용들이다.

## CVE-2016-5007

이 취약점은 2016년 7월 7일에 최초 공개됐다. 최초 공개일을 기준으로 현재 6년이 지났다. 하지만 최근까지도 스프링 프레임워크 기반 Restful API 서버를 사용하는 여러 시스템에서 심각한 보안 위협이 발견되고 있어 연구 과제로 선정했다.

스프링 시큐리티는 스프링에서 애플리케이션 인증과 권한 부여 같은 보안 기능을 제공하는 하위 프레임워크이다. CVE-2016-5007 취약점은 스프링 시큐리티가 지원하는 권한 검증과 URL 패턴 검사 로직을 우회하도록 허용시켜서 접근 권한 관리를 무력화시킨다. 즉, 접근 권한이 없는 URL에 우회 접근할 수 있다는 의미이다.

스프링 시큐리티에서 취약한 함수를 사용한다면, 버전에 상관없이 취약점이 발생한다는 점에서 매우 위협적이다.

## 스프링 프레임워크와 Restful API

스프링 프레임워크는 자바 기반 동적 웹 프레임워크로, 웹 개발에서 널리 사용되고 있다.

Restful API란 REST 아키텍처 디자인 원칙을 따르는 API로 HTTP 통신 프로토콜을 사용한다. 어떤 플랫폼이든지 API 규칙에 맞춰서 요청하면 서버에서 리소스를 응답받을 수 있어 다양한 웹 서비스에서 사용하고 있다. 공공기관 홈페이지나 주요 포털 사이트에서 제공하는 오픈 API가 REST 아키텍처를 사용하고 있다. 그래서 이를 활용해 다양한 클라이언트나 서버 환경에서 오픈 API 리소스를 활용할 수 있다.

## Restful API 서버 인증 우회 공격

Restful API 설계 규칙에서는 URI 값에 슬래시 구분자를 넣는 방법으로 계층을 구분한다. 또한, URI 값은 유일한 식별자로 사용해야 하므로, 맨 끝은 혼동을 주지 않도록 반드시 문자로 끝나야 한다. 만약 계층 구분용으로 사용해야 하는 슬래스 구분자를 URI 맨 끝에 넣느느다면 부정확한 값으로 인식될 수 있다.

스프링 프레임워크 기반 Restful API 서버라면, 스프링 시큐리티로 URI 규칙을 미리 등록해두는 방식으로 접근 제어 규칙을 설정한다. 그래서 사용자가 자원을 요청하면 미리 등록한 접근 제어 규칙과 매칭해서 허용 또는 차단을 결정한다. 

위 두 가지 특징으로 인해 Restful API 서버에 인증 또는 인가한 사용자만 접근할 수 있는 자원을 요청하는 URI 값 맨 끝에 슬래시 구분자를 붙이면, 스프링 시큐리티의 접근 제어 규칙을 우회하는 틈이 생긴다. 이 틈을 파고들면 허가 받지 않은 사용자가 내부 자원에 접근할 수 있다. 

## 대처 방법

이 취약점은 기본적으로 스프링 시큐리티 접근 제어 규칙을 화이트리스트 기반으로 설정하면 막을 수 있다. 하지만 서비스 운영상 불가피하게 블랙리스트 기반으로 규칙을 사용해야 한다면, URI 값 맨 끝에 붙인 슬래시 구분자로 접근 제어 규칙 우회를 불가능하도록 설정해야 한다. 

> 화이트리스트 & 블랙리스트

> 화이트리스트는 허용하는 조건 이외에는 모두 차단하는 접근 제어 방식이다. 

> 블랙리스트는 차단하는 조건 이외에는 모두 허용하는 접근 제어 방식이다.

블랙리스트 기반에서는 URI 끝에 와일드카드를 붙여, 대처해야 한다.

또한, 스프링 시큐리티에서는 `antMatchers()`가 가진 취약점을 보완하기 위해 보안 기능을 추가한 `mvcMatchers()`를 제공한다.

[너무 좋은 자료](https://yozm.wishket.com/magazine/detail/1347/)