# Layered Architecture

유지보수성을 갖춘 소프트웨어는 기존의 코드를 최대한 건드리지 않고, 모듈의 동작을 확장할 수 있게 한다.

이러한 유연성을 갖기 위한 여러 방법 중 code base architecture 설계에 대해 정리하려 한다.

code base architecture는 어플리케이션의 핵심이 되는 비즈니스 로직을 여러 가지 기술적인 의존성으로부터 격리시킴으로써 확장과 유지보수를 돕는 역할을 하기 때문에, 유연성 있는 소프트웨어가 갖추어야 할 필수 요소 중 하나이다.

## Layered architecture

말 그대로 계층이 나뉘어져 있는 아키텍처이다.

주된 모표는 어플릴케이션을 여러 개의 굵직한 횡단 관심사로 분리해, 각각의 레이어는 하나의 관심사에만 집중할 수 있도록 하는 것이다.

각각의 레이어에 대한 명치이은 조금씩 다르지만, 근본적인 역할과 목적은 같으며, 대표적으로 DDD에서는 아래와 같은 구조로 이루어져 있다.

[ user interface ]

[ Application ]

[ domain ] 

[ infrastructure ]

이 아키텍처의 궁극적인 목표는 application layer와 domain layer가 기술에 대해 가지는 의존성을 최소화하여 오직 순수한 비즈니스 로직을 작성하는 데에 집중할 수 있게 하는 것이다.

application layer와 domain layer에 기술 의존성이 높다면 어플리케이션의 핵심 비즈니스 로직이 기술의 변경 ( 예를 들면, 라이브러리의 종류나 버전의 변경 등 )에 강하게 결합될 것이고, 이는 기능 확장과 유지보수 관점에서 엄청난 비용을 야기할 것이다.

각 레이어의 역할을 정의하고 준수하는 것을 권고 수준에서 그친다면, ( 강력하게 하지 않는다면 )인간의 실수로 인해 발생할 에러로 인해 큰 메리트를 얻지 못할 수도 있다.

그래서 등장한 것이 gradle이라는 빌드 툴이다.

## Gradle

gradle은 성능과 유연함에 초점을 둔 오픈소스 빌드 툴이다. gradle은 굉장히 다양한 기능을 제공해주지만, 그중에서도 멀티 프로젝트 기능에 대해서 소개하려고 한다.

멀티 프로젝트 기능은 하나의 gradle 프로젝트의 하위에 여러 개의 gradle subproejct를 생성할 수 있는 기능으로, 이렇게 생성된 subproject는 각각 독립적으로 외부 의존성을 관리할 수 있다는 특징이 있다.

불필요한 의존성을 최소화한다.

## layer 살펴보기

* presentation layer

어플리케이션의 가장 프론트 엔드에 위치하는 레이어로, 백엔드 어플리케이션의 경우, 아래와 같은 역할을 한다.

1. client로부터 request를 받고, response를 하는 api 정의

2. api 라우트 별 로깅, 보안 등의 전처리 

> controller 클래스와 configuration 어노테이션이 붙은 클래스

presentation layer는 request와 response를 서빙하는 프로토콜을 무엇으로 하는 가에 지배적인 영향을 받는다. 보통의 경우, http 프로토콜을 사용하지만 그렇지 않다면 그에 따른 라이브러리나 어떠한 의존성을 추가해야 한다.

* application layer

application layer에 존재하는 함수들의 집합은 곧 어플리케이션의 요구사항이다.

> 이 문맥 와닿는다.

application layer에는 고수준으로 추상화된 어플리케이션 기능이 담겨 있다. 실제 비즈니스 로직을 담고 있지는 않고, domain layer에 존재하는 비즈니스 로직과 데이터 접근 로직을 조합하여 새로운 추상화를 창출하는 공간이라고 정의할 수 있다. 구체적으로 설명하면, 이 레이어에는 서비스 객체들이 담기게 되는데, 서비슬나 특정한 행위를 추상화하는 객체를 말한다. 

어플리케이션의 기능이라 함은 곧 어떠한 행위를 뜻하기 때문에, application layer는 자연스럽게 서비스 객체들을 담게 된다. 

> application service란 어플리케이션 요구사항에 1대 1로 대응되는 기능을 작성한 객체로, 여기에 비즈니스 로직을 작성하지 않으며, domain layer에 작성되어 있는 비즈니스 로직을 호출하기만 한다.

* domain layer

핵심 비즈니스 로직이 담기는 곳으로, 어플리케이션의 가치를 결정하는 가장 중요한 레이어이다. 이 레이어는 어떤 외부 관심사에도 의존하지 않고 순수한 비즈니스 로직만을 담아야 한다. 비즈니스 로직은 낮은 추상화 수준을 갖고 있으므로 어플리케이션 기능 단위로 직접 활용될 여지는 크지 않다.  하지만 모든 어플리케이션 기능을 구현하는 데에 사용되는 작은 조각으로써 atomic 한 로직들이 모두 이곳에 존재하기에 개발 시 이 부분을 많이 신경써야 한다.

code base architecture 방법론이 등장한 이유도 비즈니스 로직이 여러 기술적인 이슈들에 강하게 결합되어 있어서 이를 막기 위해서이다.

* infrastructure layer

위의 3개의 레이어가 각각 자신이 맡은 역할을 온전히 수행할 수 있도록 기술적인 부분에서 지원해주는 레이어이다. 

이 레이어가 맡아야 하는 기능을 크게 2가지로 분류한 예시를 소개하겠다.

1. 프레임워크를 통한 어플리케이션 구동

위에서 소개한 3개의 레이어는 각자의 역할을 잘 수행할 것이다. 그렇다면 이것들을 하나로 통합해서 하나의 어플리케이션으로 서빙하는 역할을 해줄 무언가가 필요하다. 그래서 사용하는 것이 프레임워크이다. 예시에서는 spring boot를 사용했다.

* @SpringBootApplication 어노테이션이 붙은 app 클래스
* app 클래스를 실행하는 main 함수
* application.yml 등으로 정의된 application properties
* 적절한 spring bean을 띄우기 위한 configuration 클래스들

2. 기술 종속성이 강한 구현체를 제공

domain layer에서는 외부 의존성을 최소화해야 하므로, 순수하게 로직을 구현할 수 없는 경우 인터페이스를 두고 구현체를 infrastructure layer로 분리하는 방법이 있다.

예를 들면, repository가 있다. repository는 db에 존재하는 영속 데이터로의 접근을 관리하는 객체를 아울러 이르는 용어로, repository는 어플리케이션이 어떤 dbms를 사용하는지, 어떤 orm을 사용하는 지 등 db에 대한 정보를 알고 있다. db에 관한 세부적인 내용들은 도메인과는 관계가 없는 부분이기에 domain layer에는 인터페이스만 두고, 이에 대한 구현체는 infrastructure layer에서 작성하도록 한다. 

## layered architecture의 장점

각 레이어를 느슨한 결합 형태로 구축하면서 각자 자신의 관심사에만 집중할 수 있다.

특히 핵심 비즈니스 로직을 순수하게 유지함으로써 유지보수와 확상정 측면에서 이득을 얻을 수 있다.

각 레이어에 서로 다른 추상화 수준을 가진 상태와 행동을 위치시킴으로써 코드 재사용성을 높일 수 있다.

[이 블로그 정리가 아주 잘되어 있다.](https://medium.com/riiid-teamblog-kr/gradle%EA%B3%BC-%ED%95%A8%EA%BB%98%ED%95%98%EB%8A%94-backend-layered-architecture-97117b344ba8)