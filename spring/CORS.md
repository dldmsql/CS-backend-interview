# Cross Origin

## CORS 오류가 발생하는 이유는 무엇일까

웹 개발을 하다 보면, 자주 접할 수 있는 오류 중 하나가 CORS 이다. 이것이 발생하는 이유는, 웹 브라우저는 HTTP 요청에 대해서 어떤 요청을 하느냐에 따라 각기 다른 특징을 가지고 있기 때문이다.

예를 들면, 아래와 같다.

1. HTML 태그

- `<link>` 는 href에서 다른 사이트의 .css 리소스에 접근하는 것이 가능하다.
- `<img>` 는 src에서 다른 사이트의 .png, .jpg 등과 같은 리소스에 접근하는 것이 가능하다.
- `<script>` 는 src에서 다른 사이트의 .js 리소스에 접근하는 것이 가능하다.

2. XMLHttpRequest, Fetch API
> 기본적으로 Same-Origin 정책을 따른다.

- 다른 도메인에게 ajax 요청 API 호출 시
- 웹 폰트 CSS 파일 내 @font-face 에서 다른 도메인의 폰트 사용 시
- 자바스크리비트에서의 요청은 기본적으로 서로 다른 도메인에 대한 요청을 보안상 제한한다.
- 브라우저는 기본으로 하나의 서버 연결만 허용되도록 설정되어 있기 때문이다. 

## CORS 오류 이해하기

CORS ( Cross-Origin Resources Sharing )의 약어로 직역하면 "교차 출처 리소스 공유 정책"이라고 할 수 있다. 여기서 교차 출처는 서로 다른 출처를 의미한다.

이때 출처(Origin)란 우리가 어떤 사이트를 접속할 때 인터넷 주소창에 URL을 통해 접근하게 된다. URL은 하나의 문자열 같지만, 여러 개의 구성 요소로 이루어져 있다.

| Protocol | Host | Port | Path | Query String | Fragment |
|-|-|-|-|-|-|
|Https:// | www.domain.com | :3000 | /users | ?name=우릉비&page=1 | #first |
| http / https | 사이트 도메인 | 포트 번호 | 사이트 내부 경로 | 요청의 key-value | 해시 태그 |

위의 표는 URL 구성 요소를 나타낸다. 여기서 Origin 은 Protocol + Host + Port 까지를 보면 된다.

### SOP 이해하기

SOP ( Same Origin Policy )정책은 동일한 출처에 대한 정책을 말한다. 이 정책은 동일한 출처에서만 리소스를 공유할 수 있다는 규칙을 갖는다.

즉, 동일 출처 서버에 있는 리소스는 자유로이 가져올 수 있지만, 다른 출처 서버에 있는 리소스는 자유롭게 가져올 수 없다는 말이다.

동일 출처가 아닌 경우, 접근을 차단하는 이유는 무엇일까?

출처가 다른 두 서버가 자유로이 리소스를 가져올 수 있다는 것은 매우 위험한 것이다. 리소스에 포함되는 것에는 외부에 노출되면 안되는 사용자의 개인 정보, 사이트에서 고유하게 저장하는 정보 등이 있을 수 있기 때문이다. 이러한 정보를 해커가 CSRF ( Cross-Site Request Forgery )나 XSS(Cross-Site Scripting )등의 방법을 이용해 가져갈 수 있다.

동일 출처와 다른 출처를 구분하는 기준은 무엇일까?

출처의 동일함은 URL 구성 요소 중 Protocol + Host + Port 3가지가 동일하다면 동일하다고 본다.

Port 이후의 다른 요소가 다르더라도 위의 3가지 요소만 같다면, 동일 출처로 간주한다. 
반대로 위의 3가지 요소 중 하나라도 다르다면, 브라우저는 다른 출처로 간주한다.

출처 비교와 차단은 브라우저에 구현된 기능이다. 그래서 서버가 리소스 요청에 대해 응답을 했음에도 웹 브라우저 콘솔 창에서 오류가 발생했다면, 이는 브라우저 단에서 받을 수 없도록 차단한 것이다.
> 브라우저가 정책으로 차단한다는 것은 브라우저를 통하지 않고 서버-서버 에서의 요청은 자유롭다는 뜻이다. 그래서 이를 이용한 프록시 서버가 있다.

CORS 정책으로 인해 다른 출처의 리소스 요청은 아예 받을 수 없는 것인가? 아니다.
몇 가지 예외 조항을 두고 다른 출처의 리소스 요청일지라도 여기에 해당하면 허용하기로 했는데, 그 중 하나가 `CORS 정책을 지킨 리소스 요청`이다.

즉, CORS는 브라우저의 SOP 정책에 따라 다른 출처의 리소스를 차단하면서 발생된 에러이며, 이를 해결하기 위한 방안이었다.

## 브라우저의 CORS 동작 과정

1. 클라이언트에서 HTTP 요청의 헤더에 Origin을 담아 전달

기본적으로 웹은 HTTP 프로토콜 기반으로 서버에 요청을 보내며, 이때 요청 헤더에 Origin 필드에 출처를 함께 담아 보내게 된다.

2. 서버는 응답 헤더에 Access-Control-Allow-Origin을 담아 클라이언트로 전달한다.

서버가 이 요청에 대한 응답을 할 때, 응답 헤더에 Access-Control-Allow-Origin 이라는 필드를 추가하고 값으로 `이 리소스를 접근하는 것이 허용된 출처`를 내려보낸다.

3. 클라이언트에서 자신이 보냈던 요청의 Origin과 서버가 보내준 Access-Control-Allow-Origin을 비교한다.

응답을 받은 브라우저는 자신이 보냈던 요청의 Origin과 서버가 보내준 Origin을 비교한 후 차단 여부를 결정한다. <br/>
만약 유효하지 않다면, 그 응답을 사용하지 않고 버린다. 이게 CORS 에러이다.

## CORS 해결책은 서버에게

앞서 브라우저의 CORS 동작 과정을 봤을 때, 이 오류를 해결하기 위한 방법은 서버에서 Access-Control-Allow-Origin 헤더에 허용할 출처를 기재해서 클라이언트에 응답하면 되는 것이었다. 

보다 자세한 내용을 확인하고 싶다면 [여기](https://inpa.tistory.com/entry/WEB-%F0%9F%93%9A-CORS-%F0%9F%92%AF-%EC%A0%95%EB%A6%AC-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95-%F0%9F%91%8F)에서 확인하면 된다.