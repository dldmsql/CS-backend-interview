# Spring Framework

## Spring에서 Bean 객체를 관리하는 방법 - 싱글톤

스프링에서는 빈 객체를 싱글톤으로 관리한다.

그렇다면 싱글톤이란 무엇일까?

어플리케이션이 실행될 때, 어떤 클래스가 최초 한 번만 메모리를 할당하고 그 메모리에 인스턴스를 만들어 사용하는 디자인 패턴을 말한다. 인스턴스가 1개만 생성되기 때문에 하나의 인스턴스를 메모리에 등록해서 여러 스레드가 동시에 해당 인스턴스를 공유하여 사용할 수 있게 할 수 있다.

스레드는 프로세스 내에서 실제로 작업을 수행하는 주체를 말한다. 스레드는 순서와 상관없이 실행되며, 스레드를 생성하는 데 비용이 많이 든다.

> 비용이 왜 많이 들까? <br/> 스레드는 고유의 레지스터와 스택 영역을 갖는다. 스레드의 생성을 위해서는 메모리의 할당이라는 비용이 발생하게 되는데, 자바 11에서는 스레드에 기본적으로 11MB 메모리를 예약할당한다. 스레드를 너무 많이 생성하게 되면, 메모리 할당 비용이 그만큼 증가하게 된다. 스프링에서는 스레드 풀을 사용하여 스레드를 미리 만들어 놓고 요청시 사용하고 반납하도록 한다. ( 비용이 발생하니까 무한정 만들지 않는다. )

스프링에서의 빈 객체에 대해 실제 개발에 빗대어 이해해보자.

우리가 스프링부트를 이용해서 REST API를 개발할 때, 전역에 어떤 클래스를 두고 사용했는지 떠올려보자.

@Controller, @Service, @Repsitory 와 같이 어노테이션이 붙은 빈 객체를 전역 변수에 두고 DTO와 VO 같은 객체를 지역변수로 두고 사용했다. 그 이유가 무엇일까??

하나의 공유자원을 놓고 여러 개의 스레드가 읽기/쓰기 작업을 하면서 데이터 조작 중에 문제가 발생할 수 있다. 이를 Race Condition이라 한다.

REST API에서 전역 변수로 DTO를 두었다고 가정해보자. DTO는 내부의 값이 계속 변하는 가변 객체로 이를 여러 쓰레드가 동시에 사용한다고 하면? Race condition이 발생할 것이다. 이러한 상황을 thread-safe 하지 못하다고 한다. 

@Controller, @Service, @Repsitory 와 같이 어노테이션이 붙은 빈 객체는 DTO와 달리 내부의 값이 변하는 객체가 아니다. 이를 불변객체라 한다. 

스프링은 Multi-threading 방식으로 동작하는데, 이들 간에 Thread-safe 하게 동작하는 이유가 무엇일까?
> 여기서 말하는 Thread-safe는 개발자가 컨트롤하는 것이다.

위에서 언급한 내용에서 유추할 수 있을 것이다. 빈 객체를 싱글톤으로 관리하기 때문에 여러 스레드가 요청을 하면 인스턴스를 공용으로 사용할 수 있고 이러한 빈 객체는 내부의 값이 변하지 않는 불변 객체이기 때문에 race condition으로 부터 자유롭다.

DTO와 VO 같은 가변 객체를 지역 변수로 사용함으로써 Thread-safe하게 돌아가도록 개발자를 유도하고 있다. ( 의식하지 않았지만, 스프링 프레임워크를 사용하면서 자연스레 가변 객체를 전역에 두고 공용으로 사용하지 않고 있었다. 프레임워크가 개발자로 하여금  지역변수로 사용하도록 하여 Thread-safe하게 동작하도록 유도한 것이다. )

### 스프링 빈

Bean은 스프링에서 사용하는 POJO 기반의 객체이다.

상황과 필요에 따라 빈을 사용할 때, 하나만 만들어야 할 수도 있고 여러 개가 필요할 때도 있고 어떤 한 시점에서만 사용해야 할 때가 있을 수도 있다.

이를 위해 Scope을 설정해서 빈의 사용범위를 개발자가 설정할 수도 있다.

기본 설정은 "싱글톤"이다.

그 외에는 아래와 같다.
- 프로토타입
- Request
- Session
- Global Session

이에 대해 자세히 알고 싶다면, 자료를 찾아보는 걸 권한다.

### 자바의 싱글톤 vs. 스프링의 싱글톤


|자바|스프링|
|--|--|
|자바의 싱글톤은 classloader에 의해 구현된다. | 스프링의 싱글톤은 Spring Container에 의해 구현된다. |
|자바의 싱긅톤의 Scope은 코드 전체이다. | 스프링의 싱글톤의 Scope은 해당 컨테이너 내부이다.|
|자바로 구현하는 싱글톤은 개발자의 로직에 따라 Thread-safety를 보장할 수도 보장하지 않을 수도 있다.|스프링에 의해 구현되는 싱글톤은 Thread-safety를 자동으로 보장한다.|

> [참고 자료](https://gem1n1.tistory.com/96)


자바의 싱글톤 패턴 구현 방법은 아래와 같다.

생성자를 private으로 선언한다. ( 외부에서 클래스의 오브젝트를 생성할 수 없게 하는 거다. )

그 후 참조는 static으로 정의한다. ( 외부/내부에서 접근이 가능하도록 한다. )

이렇게 하면 클래스가 classloader에 의해 단 한 번만 인스턴스화되는 것을 이용하여 구현할 수 있다.

스프링의 싱글톤 패턴은 아래와 같다.

스프링 컨테이너 내에서 특정 클래스에 대해 빈으로 등록되면 컨테이너는 이를 딱 한 개의 인스턴스로 만든다. 빈 객체가 호출될 때마다 컨테이너는 생성된 공유 인스턴스를 리턴시킨다.

[NEXT 이야기](./%5BChap-1%5D%20Spring%20MVC.md)